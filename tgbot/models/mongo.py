from datetime import datetime
from typing import Optional, Literal

from pymongo.mongo_client import MongoClient

from create_bot import config


class MongoDB:

    def __init__(self):
        # uri = config.mongo.uri
        uri = "mongodb://83.222.10.29:27017"
        client = MongoClient(uri)
        self.table = client.tgbot_db


class UsersDB(MongoDB):

    def __init__(self):
        super().__init__()
        self.__collection = self.table.users

    def create_user(self, **data):
        self.__collection.insert_one(data)

    def get_user(self, user_id: int) -> Optional[dict]:
        return self.__collection.find_one(filter={"tid": user_id})

    def update_user(self, user_id: int, update_object):
        self.__collection.update_one({"tid": user_id}, {"$set": update_object})

    def get_list_object(self,
                        user_id: int,
                        list_object: Literal["last_ticket", "currencies", "custom_currencies"]) -> list:
        user = self.__collection.find_one(filter={"tid": user_id})
        return user[list_object] if user.keys().__contains__(list_object) else []

    def get_saved_tickets(self, user_id: int) -> list:
        user = self.__collection.find_one(filter={"tid": user_id})
        if user.keys().__contains__("saved_tickets"):
            return sorted(user["saved_tickets"], key=lambda x: x["timestamp"], reverse=True)
        else:
            return []

    def get_saved_ticket_by_timestamp(self, user_id: int, timestamp: float):
        saved_tickets = self.get_saved_tickets(user_id=user_id)
        return list(filter(lambda x: x["timestamp"] == timestamp, saved_tickets))[0]

    def get_saved_tickets_after_delete(self, user_id: int, timestamp: float):
        saved_tickets = self.get_saved_tickets(user_id=user_id)
        return list(filter(lambda x: x["timestamp"] != timestamp, saved_tickets))


class RatesDB(MongoDB):
    def __init__(self):
        super().__init__()
        self.__collection = self.table.rates

    def create_rates(self, **data):
        self.__collection.insert_one(data)

    def get_rates(self):
        return self.__collection.find_one()

    def drop_collection(self):
        self.__collection.drop()

a = UsersDB()

b = RatesDB()

rates_data = {
  "date": "2023-08-05",
  "usd": {
    "00": 11.46789,
    "1inch": 3.293379,
    "aave": 0.015573,
    "abt": 11.883541,
    "ach": 58.060208,
    "acs": 500.889078,
    "ada": 3.421268,
    "aed": 3.673035,
    "aergo": 9.272137,
    "afn": 85.227525,
    "agld": 1.614466,
    "aioz": 74.074074,
    "alcx": 0.07776,
    "aleph": 13.84083,
    "algo": 9.469153,
    "alice": 1.075269,
    "all": 94.851609,
    "amd": 386.29037,
    "amp": 397.439279,
    "ang": 1.802802,
    "ankr": 41.245618,
    "ant": 0.250941,
    "aoa": 824.93597,
    "ape": 0.556019,
    "api3": 1.106807,
    "apt": 0.149365,
    "ar": 0.192117,
    "arb": 0.864977,
    "arpa": 19.84127,
    "ars": 278.878314,
    "asm": 68.469702,
    "ast": 9.551098,
    "ata": 12.445551,
    "atom": 0.118458,
    "auction": 0.17316,
    "aud": 1.518604,
    "audio": 5.980861,
    "aurora": 14.59854,
    "avax": 0.080765,
    "avt": 1.075269,
    "awg": 1.8025,
    "axl": 2.54972,
    "axs": 0.175137,
    "azn": 1.70397,
    "badger": 0.481928,
    "bake": 11.276941,
    "bal": 0.237248,
    "bam": 1.787539,
    "band": 0.841043,
    "bat": 4.834717,
    "bbd": 2.019686,
    "bch": 0.004433,
    "bdt": 109.027254,
    "bgn": 1.775559,
    "bhd": 0.377026,
    "bico": 4.620005,
    "bif": 2833.57529,
    "bit": 1.940052,
    "blur": 3.378949,
    "blz": 20.02002,
    "bmd": 1,
    "bnb": 0.004148,
    "bnd": 1.344081,
    "bnt": 1.818512,
    "bob": 6.912341,
    "boba": 7.33945,
    "bond": 0.347826,
    "brl": 4.873403,
    "bsd": 1.000338,
    "bsv": 51.351779,
    "bsw": 12.082334,
    "btc": 0.000034,
    "btcb": 0.000034,
    "btg": 0.062442,
    "btn": 82.820133,
    "btrst": 3.584229,
    "busd": 1.000076,
    "bwp": 13.453611,
    "byn": 2.524837,
    "byr": 19599.998307,
    "bzd": 2.016305,
    "c98": 7.301935,
    "cad": 1.33835,
    "cake": 0.666965,
    "cbeth": 0.000524,
    "cdf": 2440.000151,
    "celo": 2.054328,
    "celr": 71.022727,
    "cgld": 2.042901,
    "chf": 0.872607,
    "chz": 13.033878,
    "clp": 851.903838,
    "clv": 27.972028,
    "cnh": 7.184819,
    "cny": 7.170703,
    "comp": 0.017403,
    "cop": 4104.469645,
    "coti": 21.786492,
    "coval": 119.189511,
    "crc": 543.17124,
    "cro": 17.190113,
    "crpt": 9.289364,
    "crv": 1.62894,
    "ctsi": 7.092199,
    "ctx": 0.909091,
    "cuc": 1,
    "cup": 26.499998,
    "cvc": 11.682243,
    "cve": 100.778692,
    "cvx": 0.317171,
    "czk": 22.043503,
    "dai": 1.000657,
    "dar": 10.10101,
    "dash": 0.032466,
    "dcr": 0.069426,
    "ddx": 3.690037,
    "deso": 0.110926,
    "dext": 1.639613,
    "dfi": 315.869732,
    "dia": 4.184451,
    "dimo": 12.816405,
    "djf": 177.720379,
    "dkk": 6.76804,
    "dnt": 36.900369,
    "doge": 288306170.352052,
    "dop": 56.483228,
    "dot": 0.201165,
    "drep": 3.969041,
    "dyp": 6.795094,
    "dzd": 135.539527,
    "eek": 14.2126,
    "egld": 0.032202,
    "egp": 30.902822,
    "ela": 0.793336,
    "enj": 3.51214,
    "ens": 0.114351,
    "eos": 1.394108,
    "ern": 14.999999,
    "etb": 55.130099,
    "etc": 0.056188,
    "eth": 0.000548,
    "eth2": 0.000547,
    "eur": 0.90704,
    "euroc": 0.90843,
    "farm": 0.039722,
    "fei": 1.025377,
    "fet": 5.059449,
    "fida": 4.826255,
    "fil": 0.245471,
    "fis": 3.800114,
    "fjd": 2.26455,
    "fkp": 0.787038,
    "flow": 1.809531,
    "flr": 69.372182,
    "fort": 7.535795,
    "forth": 0.34965,
    "fox": 53.475936,
    "frax": 1.002012,
    "ftm": 4.303239,
    "ftt": 0.795113,
    "fx": 6.973501,
    "gal": 0.866551,
    "gala": 45.134903,
    "gbp": 0.784436,
    "gel": 2.60504,
    "gfi": 2.464572,
    "ggp": 0.787038,
    "ghs": 11.303043,
    "ghst": 1.089918,
    "gip": 0.787038,
    "glm": 4.842615,
    "gmd": 60.403848,
    "gmt": 4.893565,
    "gnf": 8603.181694,
    "gno": 0.009005,
    "gnt": 4.842797,
    "gods": 6.473959,
    "grt": 9.595317,
    "gst": 79.409196,
    "gt": 0.242044,
    "gtc": 1.015228,
    "gtq": 7.864696,
    "gusd": 1.001001,
    "gyd": 209.280415,
    "gyen": 141.843972,
    "hbar": 18.818042,
    "hft": 2.903179,
    "high": 0.853606,
    "hkd": 7.81055,
    "hnl": 24.599451,
    "hnt": 0.488272,
    "hopr": 22.050717,
    "hot": 804.000663,
    "hrk": 6.723858,
    "ht": 0.376856,
    "htg": 136.537694,
    "huf": 354.000323,
    "icp": 0.248551,
    "idex": 20.181635,
    "idr": 15152.898691,
    "ils": 3.65272,
    "ilv": 0.022477,
    "imp": 0.787038,
    "imx": 1.355932,
    "index": 0.78125,
    "inj": 0.125979,
    "inr": 82.683743,
    "inv": 0.026864,
    "iotx": 54.794521,
    "iqd": 1310.35606,
    "irr": 42312.500162,
    "isk": 131.780375,
    "jasmy": 267.737617,
    "jep": 0.787038,
    "jmd": 154.661681,
    "jod": 0.708104,
    "jpy": 141.755027,
    "jup": 201.025229,
    "kas": 21.775044,
    "kava": 1.183054,
    "kcs": 0.181742,
    "kda": 1.938366,
    "keep": 9.125753,
    "kes": 142.240373,
    "kgs": 87.833896,
    "khr": 4136.619605,
    "klay": 6.501323,
    "kmf": 449.825,
    "knc": 1.444641,
    "kpw": 899.987881,
    "krl": 4.262575,
    "krw": 1304.040271,
    "ksm": 0.045079,
    "kwd": 0.30753,
    "kyd": 0.833631,
    "kzt": 445.559447,
    "lak": 19438.27348,
    "lbp": 15014.393702,
    "lcx": 21.978022,
    "ldo": 0.544959,
    "leo": 923.237685,
    "link": 0.139981,
    "lit": 1.521144,
    "lkr": 321.104411,
    "loka": 3.996803,
    "loom": 21.314544,
    "lpt": 0.256739,
    "lqty": 0.958222,
    "lrc": 4.777302,
    "lrd": 186.703759,
    "lseth": 0.000534,
    "lsl": 18.703771,
    "ltc": 0.012179,
    "ltl": 2.95274,
    "luna": 1.790754,
    "lvl": 0.604891,
    "lyd": 4.802902,
    "mad": 9.736959,
    "magic": 1.387059,
    "mana": 2.756759,
    "mask": 0.289436,
    "math": 13.368984,
    "matic": 1.509156,
    "mco2": 0.909091,
    "mdl": 17.5555,
    "mdt": 21.874658,
    "media": 0.135777,
    "metis": 0.067408,
    "mga": 4513.174461,
    "mina": 2.317126,
    "miota": 5.900502,
    "mir": 33.360782,
    "mkd": 56.318714,
    "mkr": 0.000776,
    "mln": 0.05423,
    "mmk": 2100.572877,
    "mnde": 20.325203,
    "mnt": 3461.301771,
    "mona": 0.0027,
    "mop": 8.046301,
    "mpl": 0.172563,
    "mro": 356.999797,
    "mru": 37.8801,
    "msol": 0.038941,
    "mtl": 0.718649,
    "multi": 0.605877,
    "mur": 45.203739,
    "musd": 1.00337,
    "muse": 0.170271,
    "mvr": 15.350377,
    "mwk": 1050.78912,
    "mxc": 115.6738,
    "mxn": 17.078503,
    "myr": 4.555039,
    "mzn": 63.250372,
    "nad": 18.703728,
    "nct": 103.359173,
    "near": 0.747199,
    "neo": 0.119586,
    "nest": 104.712042,
    "nexo": 1.564739,
    "ngn": 767.450311,
    "nio": 36.595282,
    "nkn": 10.834236,
    "nmr": 0.07619,
    "nok": 10.19791,
    "npr": 132.512578,
    "nu": 13.069152,
    "nzd": 1.657649,
    "ocean": 2.951594,
    "ogn": 10.075567,
    "okb": 0.02242,
    "omg": 1.82005,
    "omr": 0.384991,
    "one": 11.125523,
    "ooki": 359.776938,
    "op": 0.593824,
    "orca": 1.188566,
    "orn": 1.602564,
    "osmo": 2.178412,
    "oxt": 19.704433,
    "pab": 1.000338,
    "pax": 1.00548,
    "paxg": 0.000515,
    "pen": 3.69106,
    "perp": 1.986689,
    "pgk": 3.634851,
    "php": 55.538499,
    "pkr": 283.533011,
    "pla": 5.91716,
    "pln": 4.028119,
    "plu": 0.123305,
    "png": 40.461258,
    "pols": 3.26744,
    "poly": 6.842285,
    "pond": 118.764846,
    "powr": 6.385696,
    "prime": 0.536337,
    "pro": 2.935995,
    "prq": 11.129661,
    "pundix": 2.614721,
    "pyg": 7288.895571,
    "pyr": 0.329435,
    "qar": 3.641038,
    "qi": 168.563,
    "qnt": 0.009777,
    "qsp": 92.678406,
    "qtum": 0.396131,
    "quick": 0.019365,
    "rad": 0.655738,
    "rai": 0.364299,
    "rare": 14.234875,
    "rari": 0.97561,
    "rbn": 4.840037,
    "ren": 17.346054,
    "rep": 0.596488,
    "repv2": 0.596488,
    "req": 12.026458,
    "rgt": 0.838032,
    "rlc": 0.864528,
    "rly": 159.5081,
    "rndr": 0.578118,
    "ron": 4.492604,
    "rose": 21.365239,
    "rpl": 0.035746,
    "rsd": 106.500513,
    "rub": 95.87503,
    "rune": 0.998872,
    "rwf": 1177.739289,
    "sand": 2.512638,
    "sar": 3.751495,
    "sbd": 8.368786,
    "scr": 13.445037,
    "sdg": 601.503626,
    "sek": 10.586903,
    "sgd": 1.339104,
    "shib": 112674.117998,
    "shp": 1.21675,
    "shping": 384.763371,
    "skk": 27.3649,
    "skl": 37.664783,
    "sle": 20.884506,
    "sll": 19749.998632,
    "snt": 39.564787,
    "snx": 0.400641,
    "sol": 0.04424,
    "sos": 569.503615,
    "spa": 196.560197,
    "spell": 2217.2949,
    "srd": 38.306034,
    "std": 20697.97922,
    "stg": 1.623455,
    "stn": 22.4816,
    "storj": 3.473428,
    "stx": 270.675458,
    "sui": 1.68976,
    "suku": 22.701476,
    "super": 11.321182,
    "sushi": 1.437711,
    "svc": 8.752159,
    "swftc": 754.43229,
    "sylo": 738.00738,
    "syn": 1.713796,
    "syp": 13099.999205,
    "szl": 18.718981,
    "t": 42.753313,
    "thb": 34.680366,
    "theta": 1.320507,
    "time": 0.058962,
    "tjs": 10.968166,
    "tmm": 17500,
    "tmt": 3.5,
    "tnd": 3.08875,
    "ton": 0.687829,
    "tone": 113.122172,
    "top": 2.36955,
    "trac": 3.870718,
    "trb": 0.084962,
    "tribe": 3.541063,
    "tru": 30.257186,
    "trx": 13.044611,
    "try": 26.940701,
    "ttd": 6.781644,
    "ttt": 342.851005,
    "tusd": 1.000551,
    "tvk": 41.45937,
    "twd": 31.666501,
    "tzs": 2505.000119,
    "uah": 36.944967,
    "ugx": 3611.08795,
    "uma": 0.636537,
    "unfi": 0.295421,
    "uni": 905.934825,
    "upi": 664.71211,
    "usd": 1,
    "usdc": 0.999997,
    "usdp": 1.00073,
    "usdt": 1.001499,
    "ust": 85.287846,
    "uyu": 37.883978,
    "uzs": 11663.146882,
    "vef": 2964801.167738,
    "ves": 30.066592,
    "vet": 55.859313,
    "vgx": 6.313131,
    "vnd": 23734.997949,
    "voxel": 7.024939,
    "vuv": 120.362767,
    "wampl": 0.29985,
    "waves": 0.538456,
    "waxl": 2.55102,
    "wbtc": 0.000034,
    "wcfg": 3.215434,
    "wemix": 1.636898,
    "wluna": 13244.450972,
    "wst": 2.754765,
    "xaf": 599.52377,
    "xag": 0.042328,
    "xau": 0.000515,
    "xcd": 2.70255,
    "xch": 0.03285,
    "xcn": 975.609756,
    "xdc": 14.112769,
    "xdr": 0.744884,
    "xec": 34383.100356,
    "xem": 33.790824,
    "xlm": 7.359607,
    "xmon": 0.000798,
    "xmr": 0.006292,
    "xof": 599.52377,
    "xpd": 0.000798,
    "xpf": 109.150355,
    "xpt": 0.001082,
    "xrp": 1.602935,
    "xtz": 1.243845,
    "xyo": 287.356322,
    "yer": 250.350342,
    "yfi": 0.000161,
    "yfii": 0.001305,
    "zar": 18.468959,
    "zec": 0.034515,
    "zen": 0.108108,
    "zil": 49.3322,
    "zmk": 9001.202811,
    "zmw": 19.305748,
    "zrx": 4.623347,
    "zwd": 374.8,
    "zwl": 321.999565
  }
}

cur_data = {"currencies": [
    "usd",
    "eur",
    "rub",
    "amd"
  ]}

ccur_data = {"custom_currencies": [
    "btc",
    "eth",
    "amd",
    "kzt"
  ]}


# a.update_user(user_id=389929933, update_object=ccur_data)

# a.create_user(**user_data)
b.create_rates(**rates_data)
# print(a.get_user(user_id=389929933))
print(b.get_rates())
